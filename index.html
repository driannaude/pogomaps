<!DOCTYPE html>
<html>
  <head>
    <title>Christchurch Pokemon Go Spawns</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" type="image/png" href="/favicon.png"/>
    <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.0/flexboxgrid.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #overlay {
        position: fixed;
        top: 0; left:0; right:0; bottom:250px;
        z-index: 999999;
        background: rgba(0,0,0,0.5);
      }
      #overlay .loading {
        height: 500px;
      }
      #overlay .loading h1 {
        color: #fff;
      }
      #map {
        height: 100%;
      }
      #legend {
        background: #FFF;
        padding: 15px;
        position:relative;
        margin: 5px 5px 0 5px;
        font-size: 12px;
        font-family: Arial, sans-serif;
        height: 250px;
        border-top:1px solid #337ab7;
        width: 100%;
        transition: all 0.2s ease-in;
        z-index: 999999999;
      }
      #tag {
        cursor: pointer;
        position: absolute;
        z-index: 9999999999;

        left: 0;
        right: 0;
        top: -41px;
        background: #fff;
        padding: 12px;
        width: 100px;
        text-align: center;
        margin: 0 auto;
        border-radius: 5px 5px 0px 0px;
        border-style: solid;
        border-width: 1px 1px 0px 1px;
      }
      .toggle-all {
        font-size: 12pt;
        margin-top: 3px;
        margin-left:25px;
      }
      #legend div#legend-list {
       height: 210px;
       padding-bottom: 75px;
       overflow: auto;
      }
      #legend li {
       list-style-type: none;
      }
    </style>
  </head>
  <body>
    <div id="overlay">
      <div class="loading row center-xs middle-xs">
        <h1>Loading...</h1>
      </div>
    </div>
    <div id="map"></div>
    <div id="capture"></div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.13.1/lodash.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script>
      function loadScript(src) {
        var element = document.createElement("script");
        element.src = src;
        document.body.appendChild(element);
      }

      function getFile(file) {
        var deferred = Q.defer();
        $.get(file, function(data){
          deferred.resolve(data);
        }).fail(function() {
          deferred.reject('ERR_HTTP');
        });
        return deferred.promise;
      }

      function cap(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      function pad(n, width, z) {
        z = z || '0';
        n = n + '';
        return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
      }

      function formatSeconds(s) {
        var date = new Date(null);
        date.setSeconds(s);

        return (date.getUTCMinutes() > 0 ? date.getUTCMinutes() + "m " : "") + date.getUTCSeconds() + "s";
      }

      function getImage(p) {
        var name = p.name;
        if (p.name == "Nidoran F") {
          name = "Nidoran";
        }
        else if (name == "Nidoran M") {
          name = "Nidorano";
        }
        return "http://icons.iconarchive.com/icons/hektakun/pokemon/72/" + pad(p.id, 3) + "-" + cap(name) + "-icon.png";
      }

      function toggleLayer(checked, pkmn) {
        console.log('is checked' + checked);
        if (!checked) {
            hidden_layers.push(pkmn);
        } else {
            var index = hidden_layers.indexOf(pkmn);
            if(index > -1){
              hidden_layers.splice(index,1);
            }
            console.log(index, hidden_layers.length, layers.length);
        }
        refreshData(null, true);
      };
      function toggleAll(checked) {

        if (!checked) {
          _.each(layers, function(layer){
            hidden_layers.push(layer);
          });
        } else {
          hidden_layers = [];
        }
        refreshData(null, true);
      };
      var panelState = true;
      function togglePanel(){
        panelState = panelState ? false : true;
        var up = '<i class="fa fa-chevron-up"></i> Show';
        var down = '<i class="fa fa-chevron-down"></i> Hide';
        console.log('toggling panel',panelState);
        if(!panelState){
          $('#tag').html(up);
          $('#legend').css('bottom','-250px');
        } else {
          $('#tag').html(down);
          $('#legend').css('bottom','0px');
        }

      }


      function refreshData(response, actionable) {
          if(actionable){
            $('#overlay').fadeIn('fast');
          }
          if(!response){
            response = [];
          }
          console.log("Refreshing data...");
          var preLength = data.length;
          if(!_.isObject(response) && !_.isEmpty(response)){
            data = JSON.parse(response);
          } else if(response === null) {
            data = [];
          } else {
            data = response;
          }
          var dataLength = data.length || 0;
          if (preLength != data.length) {
            // Clear markers
            for (var i = 0; i < markers.length; i++) {
              listeners[i].a.remove();
              listeners[i].b.remove();
              markers[i].setMap(null);
            }
            listeners = [];
            markers = [];

            // Add updated markers
            for (var i = 0; i < data.length; i++) {
              var p = data[i];
              if (!updated) {
                map.setZoom(12);
                map.panTo({lat: p.lat, lng: p.lng});
                updated = true;
              }

              if(hidden_layers.indexOf(p.name) == -1){
                // Pokemon not hidden
                if(layers.indexOf(p.name) == -1){
                  layers.push(p.name);
                }
                // console.log("Adding marker " + p.name);

                var infowindow = new google.maps.InfoWindow({
                });

                var image = getImage(p);

                var marker = new google.maps.Marker({
                  map: map,
                  position: {lat: p.lat, lng: p.lng},
                  label: "",
                  title: "<b>"+p.name+"</b><br>Time left: " + formatSeconds(p.timeleft) + "<br>Lat: "+p.lat+"<br>Long: "+p.lng,
                  icon: image
                });

                var listenerPair = {
                  a: google.maps.event.addListener(marker, 'mouseover', function() {
                    infowindow.setContent(this.title);
                    infowindow.open(map, this);
                  }),

                  b: google.maps.event.addListener(marker, 'mouseout', function() {
                    infowindow.close(map, this);
                  })
                };

                listeners.push(listenerPair);
                markers.push(marker);
              }
            }
            layers = layers.sort();
            // Draw layer manager
            var list = document.getElementById('legend-list');
            var content = [];
            for (var id in layers) {
              var pkmn = layers[id];
              var checked = hidden_layers.indexOf(pkmn) != -1 ? "" : "checked";
              content.push("<li class='col-xl-3 col-lg-4 col-md-4 col-xs-6'><input type='checkbox' id='" + pkmn +  "'" +
              " onclick='toggleLayer(this.checked, this.id)' "+checked+"\/>&nbsp;" +
              pkmn + "<\/li>");
            }
            list.innerHTML = content.join('');
            if(actionable){

              google.maps.event.addListenerOnce(window.map, 'idle', function(){
                // do something only the first time the map is loaded
                $('#overlay').fadeOut('fast');
              });
            } else if($('#overlay').is(':visible')) {
              $('#overlay').fadeOut('fast');
            }
          } else {
            console.log('likely the same data');
          }

      }

      data = {};
      map = null;
      markers = [];
      listeners = [];
      hidden_layers = [];
      layers = [];
      updated = false;


      getFile("config.json").then(function(configData) {
        var config;
        if(!_.isObject(configData)){
          config = JSON.parse(configData);
        } else {
          config = configData;
        }
        console.log("Using api key: " + config.GOOGLE_MAPS_API_KEY);
        loadScript("https://maps.googleapis.com/maps/api/js?key=" + config.GOOGLE_MAPS_API_KEY + "&libraries=drawing&callback=initMap");
      });

      function initMap() {
        console.log("Initializing map");

        window.map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -43.5321, lng: 172.6362},
          zoom: 12
        });

        var legend = document.createElement('div');
        legend.id = 'legend';
        var content = [];
        content.push('<a id="tag" onclick="togglePanel()"><i class="fa fa-chevron-down"></i> Hide</a>');
        content.push('<div class="row start-xs middle-xs"><h3 style="margin:0" class="col-xs-6"><span class="pull-left">Show Pokemon</span>');
        content.push("<li class='pull-left toggle-all'><input type='checkbox' id='allcheck'" +
        " onclick='toggleAll(this.checked)' checked \/>&nbsp;<strong>Toggle All</strong></li></h3><\/div>");
        content.push('<div id="legend-list" class="row"></li></div>');
        legend.innerHTML = content.join('');
        legend.index = 1;
        window.map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(legend);

        setInterval(function(){
          var pokemons = [];
          getFile('data.sumner.json').then(function(res){
            pokemons = res;
            return getFile('data.brighton.json');
          }).then(function(res){
            _.each(res, function(pokemon){
              pokemons.push(pokemon);
            });
            return getFile('data.hagley.json');
          }).then(function(res){
            _.each(res, function(pokemon){
              pokemons.push(pokemon);
            });
            refreshData(pokemons);
          });
        }, 5000);
      }
      function isPortrait() {
        return window.innerHeight > window.innerWidth;
      }
      // Listen for orientation changes
      window.addEventListener("orientationchange", function() {
        // Announce the new orientation number
        if(!isPortrait()){
          alert('Portrait mode is the ideal orientation.');
        }
      }, false);
    </script>

  </body>
</html>
